<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapping History</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #e5e7eb; }
      .top { height: 52px; background: #1e3a8a; display: flex; align-items: center; justify-content: space-between; padding: 0 14px; }
      .shell { display: grid; grid-template-columns: 230px 1fr; min-height: calc(100vh - 52px); }
      .nav { background: #0f172a; border-right: 1px solid #1f2937; padding: 14px 10px; }
      .nav a { display: block; color: #cbd5e1; text-decoration: none; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; }
      .nav a.active, .nav a:hover { background: #1e3a8a; color: #fff; }
      .main { padding: 18px; }
      .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 10px; padding: 14px; }
      table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
      th, td { text-align: left; padding: 9px; border-bottom: 1px solid #1f2937; }
      .sub { color: #94a3b8; margin-bottom: 10px; font-size: 0.9rem; }
      .msg { color: #93c5fd; margin-bottom: 8px; font-size: 0.85rem; }
    </style>
  </head>
  <body>
    <div class="top">
      <div><strong>Data Mapping Studio</strong></div>
      <div>{{ username }} ({{ user_role }}) | <a href="/logout" style="color:#dbeafe;">Logout</a></div>
    </div>
    <div class="shell">
      <div class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/mapping">Mapping Workspace</a>
        <a href="/mapping-history" class="active">Mapping History</a>
        <a href="/datasources">Database Connections</a>
        <a href="/settings">Settings</a>
        <a href="/audit-logs">Audit Logs</a>
      </div>
      <div class="main">
        <h2 style="margin:0 0 4px 0;">Mapping History</h2>
        <div class="sub">View and monitor previous mapping runs</div>
        <div class="msg" id="msg"></div>
        <div class="card">
          <table>
            <thead>
              <tr><th>Run ID</th><th>Date/Time</th><th>User</th><th>Source DB</th><th>Target DB</th><th>Fields</th><th>Status</th></tr>
            </thead>
            <tbody id="history_body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
      (function () {
        var msgEl = document.getElementById('msg');
        var bodyEl = document.getElementById('history_body');

        function show(msg, isErr) {
          msgEl.textContent = msg || '';
          msgEl.style.color = isErr ? '#fca5a5' : '#93c5fd';
        }

        function fmtDateTime(isoTs) {
          var d = new Date(isoTs || '');
          if (Number.isNaN(d.getTime())) return '-';
          return d.toISOString().replace('T', ' ').slice(0, 16);
        }

        function load() {
          fetch('/api/mapping-runs')
            .then(function (r) {
              if (!r.ok) throw new Error('Failed to load mapping history');
              return r.json();
            })
            .then(function (data) {
              var rows = data.runs || [];
              if (!rows.length) {
                bodyEl.innerHTML = '<tr><td colspan="7" class="sub">No mapping runs available yet.</td></tr>';
                return;
              }
              bodyEl.innerHTML = rows.map(function (r) {
                var sourceDb = r.source_database || r.source_datasource_name || '-';
                var targetDb = r.target_database || r.target_datasource_name || '-';
                var fields = String(r.matched_fields || 0) + ' / ' + String(r.total_fields || 0);
                return '<tr>' +
                  '<td>' + (r.run_id || '-') + '</td>' +
                  '<td>' + fmtDateTime(r.created_at) + '</td>' +
                  '<td>' + (r.created_by || '-') + '</td>' +
                  '<td>' + sourceDb + '</td>' +
                  '<td>' + targetDb + '</td>' +
                  '<td>' + fields + '</td>' +
                  '<td>' + (r.status || '-') + '</td>' +
                '</tr>';
              }).join('');
              show('');
            })
            .catch(function (e) {
              show(e.message || 'Unable to load mapping history', true);
              bodyEl.innerHTML = '<tr><td colspan="7" class="sub">Unable to load mapping runs.</td></tr>';
            });
        }

        load();
      })();
    </script>
  </body>
</html>
