<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Data Mapping Sheet Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(135deg, #0f172a, #1f2937);
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .card {
        width: 100%;
        max-width: 1040px;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 16px;
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.3);
        overflow: hidden;
      }
      .card-header {
        padding: 20px 24px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }
      .title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #e5e7eb;
      }
      .subtitle {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-top: 4px;
      }
      .badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.15);
        color: #bfdbfe;
        border: 1px solid rgba(59, 130, 246, 0.5);
      }
      .build-meta {
        font-size: 0.72rem;
        color: #93c5fd;
        margin-top: 6px;
      }
      .card-body {
        padding: 20px 24px 24px;
      }
      .landing {
        border: 1px solid rgba(148, 163, 184, 0.22);
        border-radius: 14px;
        padding: 18px;
        background: rgba(30, 41, 59, 0.35);
        margin-bottom: 16px;
      }
      .landing-title {
        font-size: 1rem;
        font-weight: 600;
        color: #dbeafe;
      }
      .landing-text {
        margin-top: 8px;
        color: #cbd5e1;
        font-size: 0.86rem;
        line-height: 1.45;
      }
      .landing-grid {
        margin-top: 14px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }
      .landing-card {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(15, 23, 42, 0.5);
      }
      .landing-card h4 {
        margin: 0 0 6px 0;
        font-size: 0.83rem;
        color: #bfdbfe;
      }
      .landing-card p {
        margin: 0;
        font-size: 0.78rem;
        color: #cbd5e1;
      }
      .launch-row {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .kpi-grid {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }
      .kpi-card {
        border: 1px solid rgba(148, 163, 184, 0.24);
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(15, 23, 42, 0.58);
      }
      .kpi-label {
        font-size: 0.73rem;
        color: #93c5fd;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .kpi-value {
        margin-top: 4px;
        font-size: 1rem;
        font-weight: 600;
        color: #e2e8f0;
      }
      .workspace.hidden {
        display: none;
      }
      .param-tabs {
        margin-bottom: 14px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .param-tab {
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.8);
        color: #cbd5e1;
        border-radius: 999px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 0.78rem;
      }
      .param-tab.active {
        border-color: rgba(59, 130, 246, 0.8);
        color: #dbeafe;
        background: rgba(37, 99, 235, 0.3);
      }
      .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #e5e7eb;
      }
      .connection-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
      }
      .connection-group label {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: #9ca3af;
        margin-bottom: 6px;
      }
      .connection-group select {
        width: 100%;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
      }
      label {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: #e5e7eb;
        margin-bottom: 4px;
      }
      .field-hint {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 2px;
      }
      input,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        font-size: 0.85rem;
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease,
          background-color 0.15s ease;
      }
      input:focus,
      select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
        background: rgba(15, 23, 42, 1);
      }
      input::placeholder {
        color: #6b7280;
      }
      .password-input {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .password-input input {
        flex: 1;
      }
      .password-toggle {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.9);
        color: #cbd5e1;
        font-size: 0.75rem;
        cursor: pointer;
        white-space: nowrap;
      }
      .password-toggle:hover {
        border-color: #3b82f6;
      }
      .credential-section {
        margin-bottom: 20px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(31, 41, 55, 0.4);
      }
      .credential-section.hidden {
        display: none;
      }
      .hidden {
        display: none;
      }
      .help-tooltip {
        position: relative;
        display: inline-flex;
        margin-left: 6px;
        vertical-align: middle;
      }
      .help-tooltip-icon {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(59, 130, 246, 0.3);
        color: #93c5fd;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: help;
      }
      .help-tooltip-content {
        display: none;
        position: absolute;
        left: 0;
        top: 100%;
        margin-top: 6px;
        padding: 10px 12px;
        max-width: 320px;
        font-size: 0.8rem;
        line-height: 1.4;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.98);
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10;
      }
      .help-tooltip:hover .help-tooltip-content {
        display: block;
      }
      .test-connection-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
      }
      .btn-test {
        padding: 6px 14px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(31, 41, 55, 0.8);
        color: #e5e7eb;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .btn-test:hover {
        background: rgba(55, 65, 81, 0.9);
      }
      .btn-test:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .test-result {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 6px;
      }
      .test-result.success {
        color: #86efac;
        background: rgba(34, 197, 94, 0.15);
      }
      .test-result.error {
        color: #fca5a5;
        background: rgba(239, 68, 68, 0.15);
      }
      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
        align-items: center;
      }
      .btn-primary {
        padding: 8px 18px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        color: #e5e7eb;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn-primary:hover {
        filter: brightness(1.05);
      }
      .btn-secondary {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: transparent;
        color: #e5e7eb;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .status {
        font-size: 0.8rem;
        color: #9ca3af;
      }
      .status span {
        color: #a5b4fc;
        font-weight: 500;
      }
      .submit-status {
        margin-top: 10px;
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 0.82rem;
      }
      .submit-status.hidden {
        display: none;
      }
      .submit-status.success {
        color: #86efac;
        background: rgba(34, 197, 94, 0.15);
      }
      .submit-status.error {
        color: #fca5a5;
        background: rgba(239, 68, 68, 0.15);
      }
      @media (max-width: 640px) {
        .card {
          border-radius: 12px;
        }
        .card-header,
        .card-body {
          padding: 16px;
        }
        .connection-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="card-header">
        <div>
          <div class="title">Data Mapping Sheet Generator</div>
          <div class="subtitle">
            Select source and target · Salesforce, MSSQL, MySQL &rarr; Redshift, MSSQL, MySQL
          </div>
          <div class="build-meta">
            Build: <span id="build-id">{{ app_build }}</span>
          </div>
        </div>
        <div>
          <div class="badge">Multi-Source · Multi-Target</div>
          <div class="build-meta" style="text-align:right;">
            User: {{ username or "user" }} ({{ user_role or "user" }})
            {% if user_role == "admin" %}&nbsp;|&nbsp;<a href="/datasources" style="color:#93c5fd;">Data sources</a>{% endif %}
            &nbsp;|&nbsp;<a href="/logout" style="color:#93c5fd;">Logout</a>
          </div>
        </div>
      </div>

      <div class="card-body">
        <section id="home-landing" class="landing">
          <div class="landing-title">Executive Overview: Metadata-to-Mapping Studio</div>
          <div class="landing-text">
            Enterprise data programs often lose time in manual schema interpretation, inconsistent mapping templates, and repeated back-and-forth between analysts and ETL engineers.
            This studio turns live source/target metadata into actionable mapping sheets, reducing rework and improving delivery predictability.
          </div>
          <div class="landing-grid">
            <div class="landing-card">
              <h4>1) Problem We Solve</h4>
              <p>Manual mapping creation is slow, error-prone, and difficult to standardize across teams and projects.</p>
            </div>
            <div class="landing-card">
              <h4>2) Business Value</h4>
              <p>Metadata-driven mapping accelerates ETL design, improves requirement clarity, and creates a reusable baseline for engineering implementation.</p>
            </div>
            <div class="landing-card">
              <h4>3) Current Outcomes</h4>
              <p>Supports Salesforce, MSSQL, MySQL, and Redshift with dynamic connectors, testable connections, and one-click mapping sheet generation.</p>
            </div>
            <div class="landing-card">
              <h4>4) Roadmap Significance</h4>
              <p>AI-enhanced matching and ETL pattern suggestions can convert engineer-authored transformation logic into faster, higher-confidence mapping recommendations.</p>
            </div>
          </div>
          <div class="launch-row">
            <button type="button" id="launch-workspace-btn" class="btn-primary">
              Launch Mapping Studio
            </button>
            <button type="button" id="presentation-mode-btn" class="btn-secondary">
              Presentation Mode
            </button>
            <button type="button" class="btn-secondary" onclick="window.location.href='/security/notes';">
              Security notes
            </button>
          </div>
        </section>

        <section id="presentation-panel" class="landing hidden">
          <div class="landing-title">Presentation Mode: Executive Summary</div>
          <div class="landing-text">
            This mode highlights business outcomes, operational value, and roadmap impact while hiding detailed engineering controls.
            Use it for leadership demos, steering discussions, and investment alignment sessions.
          </div>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Connector Coverage</div>
              <div class="kpi-value">4 Platforms</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Primary Outcome</div>
              <div class="kpi-value">Faster Mapping Cycle</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Delivery Artifact</div>
              <div class="kpi-value">Excel Mapping Sheet</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Roadmap Focus</div>
              <div class="kpi-value">AI-Enhanced ETL Mapping</div>
            </div>
          </div>
          <div class="launch-row">
            <button type="button" id="launch-from-presentation-btn" class="btn-primary">
              Launch Mapping Studio
            </button>
            <button type="button" id="exit-presentation-btn" class="btn-secondary">
              Back to Overview
            </button>
          </div>
        </section>

        <div id="workspace" class="workspace hidden">
        <form method="post" action="/ui/generate-mapping" id="mapping-form">
          <div class="connection-row">
            <div class="connection-group">
              <label for="source_type">Source connection</label>
              <select id="source_type" name="source_type" required>
                <option value="salesforce">Salesforce</option>
                <option value="mssql">MSSQL (SQL Server)</option>
                <option value="mysql">MySQL</option>
              </select>
            </div>
            <div class="connection-group">
              <label for="target_type">Target connection</label>
              <select id="target_type" name="target_type" required>
                <option value="redshift">Amazon Redshift</option>
                <option value="mssql">MSSQL (SQL Server)</option>
                <option value="mysql">MySQL</option>
              </select>
            </div>
          </div>

          <div class="connection-row">
            <div class="connection-group">
              <label for="source_datasource_id">Source data source</label>
              <select id="source_datasource_id" name="source_datasource_id">
                <option value="">-- Select configured source --</option>
              </select>
              <div class="field-hint">Configured by admin. Select one to load schemas/tables.</div>
            </div>
            <div class="connection-group">
              <label for="target_datasource_id">Target data source</label>
              <select id="target_datasource_id" name="target_datasource_id">
                <option value="">-- Select configured target --</option>
              </select>
              <div class="field-hint">Configured by admin. Select one to load schemas/tables.</div>
            </div>
          </div>

          <div class="connection-row">
            <div class="connection-group">
              <label for="source_schema">Source schema/database</label>
              <select id="source_schema" name="source_schema">
                <option value="">-- Select source schema --</option>
              </select>
            </div>
            <div class="connection-group">
              <label for="target_schema">Target schema/database</label>
              <select id="target_schema" name="target_schema">
                <option value="">-- Select target schema --</option>
              </select>
            </div>
          </div>

          <div class="connection-row">
            <div class="connection-group">
              <label for="source_object">Source object / table name</label>
              <input
                id="source_object"
                name="source_object"
                type="text"
                placeholder="e.g. Account or my_table"
                list="source_object_list"
                required
              />
              <datalist id="source_object_list"></datalist>
              <div class="test-connection-row">
                <button type="button" class="btn-test" id="source-load-objects-btn">Load source tables</button>
                <span id="source-load-result" class="test-result" aria-live="polite"></span>
              </div>
            </div>
            <div class="connection-group">
              <label for="target_table">Target table name</label>
              <input
                id="target_table"
                name="target_table"
                type="text"
                placeholder="e.g. account or my_table"
                list="target_table_list"
                required
              />
              <datalist id="target_table_list"></datalist>
              <div class="test-connection-row">
                <button type="button" class="btn-test" id="target-load-objects-btn">Load target tables</button>
                <span id="target-load-result" class="test-result" aria-live="polite"></span>
              </div>
            </div>
          </div>

          <div class="param-tabs" id="param-tabs">
            <button type="button" class="param-tab active" data-tab="source">Source parameters</button>
            <button type="button" class="param-tab" data-tab="target">Target parameters</button>
            <button type="button" class="param-tab" data-tab="all">Both</button>
          </div>

          <div id="section-salesforce" class="credential-section hidden" data-for="source" data-type="salesforce">
            <div class="section-title">Salesforce connection</div>
            <div class="grid">
              <div>
                <label for="sf_username">Username</label>
                <input id="sf_username" name="sf_username" type="text" placeholder="salesforce.user@company.com" />
              </div>
              <div>
                <label for="sf_password">Password</label>
                <div class="password-input">
                  <input id="sf_password" name="sf_password" type="password" placeholder="Salesforce password" />
                  <button type="button" class="password-toggle" data-target="sf_password">Show</button>
                </div>
              </div>
              <div>
                <label for="sf_security_token">Security token</label>
                <div class="password-input">
                  <input id="sf_security_token" name="sf_security_token" type="password" placeholder="Security token" />
                  <button type="button" class="password-toggle" data-target="sf_security_token">Show</button>
                </div>
                <div class="field-hint">Profile &gt; Reset Security Token</div>
              </div>
              <div>
                <label for="sf_domain">Domain</label>
                <select id="sf_domain" name="sf_domain">
                  <option value="login">login (Production)</option>
                  <option value="test">test (Sandbox)</option>
                </select>
              </div>
            </div>
            <div class="test-connection-row">
              <button type="button" class="btn-test" id="sf-test-btn">Test connection</button>
              <span id="sf-test-result" class="test-result" aria-live="polite"></span>
            </div>
          </div>

          <div id="section-redshift" class="credential-section hidden" data-for="target" data-type="redshift">
            <div class="section-title">Redshift connection</div>
            <div class="grid">
              <div>
                <label for="rs_host">Host</label>
                <input id="rs_host" name="rs_host" type="text" placeholder="cluster.region.redshift.amazonaws.com" />
              </div>
              <div>
                <label for="rs_port">Port</label>
                <input id="rs_port" name="rs_port" type="number" value="5439" />
              </div>
              <div>
                <label for="rs_database">Database</label>
                <input id="rs_database" name="rs_database" type="text" placeholder="dev" />
              </div>
              <div>
                <label for="rs_user">User</label>
                <input id="rs_user" name="rs_user" type="text" placeholder="redshift_user" />
              </div>
              <div>
                <label for="rs_password">Password</label>
                <div class="password-input">
                  <input id="rs_password" name="rs_password" type="password" placeholder="Password" />
                  <button type="button" class="password-toggle" data-target="rs_password">Show</button>
                </div>
              </div>
              <div>
                <label for="rs_schema">Schema</label>
                <input id="rs_schema" name="rs_schema" type="text" value="public" />
              </div>
            </div>
            <div class="test-connection-row">
              <button type="button" class="btn-test" id="rs-test-btn">Test connection</button>
              <span id="rs-test-result" class="test-result" aria-live="polite"></span>
            </div>
          </div>

          <div id="section-mssql" class="credential-section hidden" data-for="both" data-type="mssql">
            <div class="section-title">MSSQL (SQL Server) connection</div>
            <div class="grid">
              <div>
                <label for="mssql_auth_type">
                  Authentication
                  <span class="help-tooltip">
                    <span class="help-tooltip-icon" aria-hidden="true">?</span>
                    <span class="help-tooltip-content">
                      <strong>SQL Server authentication:</strong> Use a database user name and password. Best for remote servers or when you don’t use a domain account.<br><br>
                      <strong>Windows authentication:</strong> Uses your current Windows login (no password in the form). Ideal for localhost or when SQL Server is configured for Integrated Security. The app runs as your Windows user.
                    </span>
                  </span>
                </label>
                <select id="mssql_auth_type" name="mssql_auth_type">
                  <option value="sql">SQL Server authentication (user &amp; password)</option>
                  <option value="windows">Windows authentication (current user)</option>
                </select>
                <div class="field-hint">
                  Windows authentication uses your current Windows login on this machine.
                </div>
              </div>
              <div>
                <label for="mssql_host">Host</label>
                <input id="mssql_host" name="mssql_host" type="text" placeholder="localhost or localhost\SQLEXPRESS" />
              </div>
              <div>
                <label for="mssql_port">Port</label>
                <input id="mssql_port" name="mssql_port" type="number" value="1433" />
              </div>
              <div>
                <label for="mssql_database">Database</label>
                <input id="mssql_database" name="mssql_database" type="text" placeholder="mydb" />
              </div>
              <div>
                <label for="mssql_user">User</label>
                <input id="mssql_user" name="mssql_user" type="text" placeholder="sa or user" />
              </div>
              <div>
                <label for="mssql_password">Password</label>
                <div class="password-input">
                  <input id="mssql_password" name="mssql_password" type="password" placeholder="Password" />
                  <button type="button" class="password-toggle" data-target="mssql_password">Show</button>
                </div>
              </div>
              <div>
                <label for="mssql_schema">Schema</label>
                <input id="mssql_schema" name="mssql_schema" type="text" value="dbo" />
              </div>
              <div>
                <label for="mssql_driver">ODBC driver (optional)</label>
                <input
                  id="mssql_driver"
                  name="mssql_driver"
                  type="text"
                  placeholder="ODBC Driver 17 for SQL Server"
                  data-optional="true"
                />
                <div class="field-hint">
                  Leave blank to use the default installed SQL Server ODBC driver.
                </div>
              </div>
            </div>
            <div class="test-connection-row">
              <button type="button" class="btn-test" id="mssql-test-btn">Test connection</button>
              <span id="mssql-test-result" class="test-result" aria-live="polite"></span>
            </div>
          </div>

          <div id="section-mysql" class="credential-section hidden" data-for="both" data-type="mysql">
            <div class="section-title">MySQL connection</div>
            <div class="grid">
              <div>
                <label for="mysql_host">Host</label>
                <input id="mysql_host" name="mysql_host" type="text" placeholder="localhost or host.example.com" />
              </div>
              <div>
                <label for="mysql_port">Port</label>
                <input id="mysql_port" name="mysql_port" type="number" value="3306" />
              </div>
              <div>
                <label for="mysql_database">Database</label>
                <input id="mysql_database" name="mysql_database" type="text" placeholder="mydb" />
              </div>
              <div>
                <label for="mysql_user">User</label>
                <input id="mysql_user" name="mysql_user" type="text" placeholder="root or user" />
              </div>
              <div>
                <label for="mysql_password">Password</label>
                <div class="password-input">
                  <input id="mysql_password" name="mysql_password" type="password" placeholder="Password" />
                  <button type="button" class="password-toggle" data-target="mysql_password">Show</button>
                </div>
              </div>
              <div>
                <label for="mysql_schema">Schema (optional)</label>
                <input id="mysql_schema" name="mysql_schema" type="text" placeholder="same as database if empty" data-optional="true" />
              </div>
            </div>
            <div class="test-connection-row">
              <button type="button" class="btn-test" id="mysql-test-btn">Test connection</button>
              <span id="mysql-test-result" class="test-result" aria-live="polite"></span>
            </div>
          </div>

          <div class="actions">
            <div class="status">
              Output:&nbsp;<span>mapping_sheet.xlsx</span>
            </div>
            <button type="button" id="back-home-btn" class="btn-secondary">
              Home
            </button>
            <button type="button" class="btn-secondary" onclick="window.location.href='/docs';">
              API docs
            </button>
            <button type="submit" class="btn-primary">
              <span id="generate-label">Generate mapping sheet</span>
              <span id="generate-spinner" class="hidden">Processing…</span>
              <span>↓</span>
            </button>
          </div>
          <div id="submit-status" class="submit-status hidden" aria-live="polite"></div>
        </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        var mappingForm = document.getElementById('mapping-form');
        var homeLanding = document.getElementById('home-landing');
        var presentationPanel = document.getElementById('presentation-panel');
        var workspace = document.getElementById('workspace');
        var sourceDatasourceSelect = document.getElementById('source_datasource_id');
        var targetDatasourceSelect = document.getElementById('target_datasource_id');
        var sourceSchemaSelect = document.getElementById('source_schema');
        var targetSchemaSelect = document.getElementById('target_schema');
        var sourceLoadBtn = document.getElementById('source-load-objects-btn');
        var targetLoadBtn = document.getElementById('target-load-objects-btn');
        var sourceLoadResult = document.getElementById('source-load-result');
        var targetLoadResult = document.getElementById('target-load-result');
        var sourceObjectList = document.getElementById('source_object_list');
        var targetTableList = document.getElementById('target_table_list');
        var launchWorkspaceBtn = document.getElementById('launch-workspace-btn');
        var launchFromPresentationBtn = document.getElementById('launch-from-presentation-btn');
        var presentationModeBtn = document.getElementById('presentation-mode-btn');
        var exitPresentationBtn = document.getElementById('exit-presentation-btn');
        var backHomeBtn = document.getElementById('back-home-btn');
        var paramTabs = document.querySelectorAll('.param-tab');
        var passwordToggles = document.querySelectorAll('.password-toggle');
        var activeParamTab = 'source';
        var profileCache = [];
        var submitStatus = document.getElementById('submit-status');
        var generateLabel = document.getElementById('generate-label');
        var generateSpinner = document.getElementById('generate-spinner');

        function launchWorkspace() {
          if (homeLanding) homeLanding.classList.add('hidden');
          if (presentationPanel) presentationPanel.classList.add('hidden');
          if (workspace) workspace.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
          updateVisibility();
        }

        function goHome() {
          if (workspace) workspace.classList.add('hidden');
          if (presentationPanel) presentationPanel.classList.add('hidden');
          if (homeLanding) homeLanding.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function initPasswordToggles() {
          passwordToggles.forEach(function (toggleBtn) {
            toggleBtn.addEventListener('click', function () {
              var targetId = toggleBtn.getAttribute('data-target');
              var input = targetId ? document.getElementById(targetId) : null;
              if (!input) return;
              var show = input.type === 'password';
              input.type = show ? 'text' : 'password';
              toggleBtn.textContent = show ? 'Hide' : 'Show';
            });
          });
        }

        function showInlineResult(el, message, isError) {
          if (!el) return;
          el.textContent = message;
          el.className = 'test-result ' + (isError ? 'error' : 'success');
        }

        function buildDatasourceOptions(selectEl, connectionType, selectedId) {
          if (!selectEl) return;
          var options = ['<option value="">-- Select configured source/target --</option>'];
          profileCache
            .filter(function (p) { return p.connection_type === connectionType; })
            .forEach(function (p) {
              var selected = p.id === selectedId ? ' selected' : '';
              options.push('<option value="' + p.id + '"' + selected + '>' + p.name + '</option>');
            });
          selectEl.innerHTML = options.join('');
        }

        function refreshDatasourceOptions() {
          var sourceType = valueOf('source_type');
          var targetType = valueOf('target_type');
          var currentSource = sourceDatasourceSelect ? sourceDatasourceSelect.value : '';
          var currentTarget = targetDatasourceSelect ? targetDatasourceSelect.value : '';
          buildDatasourceOptions(sourceDatasourceSelect, sourceType, currentSource);
          buildDatasourceOptions(targetDatasourceSelect, targetType, currentTarget);
        }

        function loadDatasources() {
          fetch('/api/datasources')
            .then(function (r) { return r.json(); })
            .then(function (data) {
              profileCache = data.datasources || [];
              refreshDatasourceOptions();
            })
            .catch(function () {
              profileCache = [];
              refreshDatasourceOptions();
            });
        }

        function fillDatalist(datalistEl, values) {
          if (!datalistEl) return;
          datalistEl.innerHTML = '';
          values.forEach(function (item) {
            var option = document.createElement('option');
            option.value = item;
            datalistEl.appendChild(option);
          });
        }

        function loadObjectsForRole(role) {
          var selectEl = role === 'source' ? sourceDatasourceSelect : targetDatasourceSelect;
          var schemaEl = role === 'source' ? sourceSchemaSelect : targetSchemaSelect;
          var resultEl = role === 'source' ? sourceLoadResult : targetLoadResult;
          var btnEl = role === 'source' ? sourceLoadBtn : targetLoadBtn;
          var datalistEl = role === 'source' ? sourceObjectList : targetTableList;
          if (!selectEl || !btnEl) return;

          if (!selectEl.value) {
            showInlineResult(resultEl, 'Select a saved profile first.', true);
            return;
          }

          btnEl.disabled = true;
          showInlineResult(resultEl, 'Loading...', false);
          var schema = schemaEl ? schemaEl.value : '';
          var url = '/api/datasources/' + selectEl.value + '/tables';
          if (schema) {
            url += '?schema=' + encodeURIComponent(schema);
          }
          fetch(url)
            .then(function (r) { return r.json(); })
            .then(function (data) {
              var items = data.tables || [];
              fillDatalist(datalistEl, items);
              showInlineResult(resultEl, 'Loaded ' + items.length + ' entries.', false);
            })
        function loadSchemasForRole(role) {
          var dsSelect = role === 'source' ? sourceDatasourceSelect : targetDatasourceSelect;
          var schemaSelect = role === 'source' ? sourceSchemaSelect : targetSchemaSelect;
          if (!dsSelect || !schemaSelect) return;
          if (!dsSelect.value) {
            schemaSelect.innerHTML = '<option value="">-- Select schema --</option>';
            return;
          }
          fetch('/api/datasources/' + dsSelect.value + '/schemas')
            .then(function (r) { return r.json(); })
            .then(function (data) {
              var schemas = data.schemas || [];
              var options = ['<option value="">-- Select schema --</option>'];
              schemas.forEach(function (s) {
                options.push('<option value="' + s + '">' + s + '</option>');
              });
              schemaSelect.innerHTML = options.join('');
            })
            .catch(function () {
              schemaSelect.innerHTML = '<option value="">-- Select schema --</option>';
            });
        }
            .catch(function (err) {
              showInlineResult(resultEl, err.message || 'Failed to load entries.', true);
            })
            .finally(function () {
              btnEl.disabled = false;
            });
        }

        function enterPresentationMode() {
          if (homeLanding) homeLanding.classList.add('hidden');
          if (workspace) workspace.classList.add('hidden');
          if (presentationPanel) presentationPanel.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exitPresentationMode() {
          if (presentationPanel) presentationPanel.classList.add('hidden');
          if (homeLanding) homeLanding.classList.remove('hidden');
        }

        function showSubmitStatus(message, isError) {
          if (!submitStatus) return;
          submitStatus.textContent = message;
          submitStatus.className = 'submit-status ' + (isError ? 'error' : 'success');
        }

        function clearSubmitStatus() {
          if (!submitStatus) return;
          submitStatus.textContent = '';
          submitStatus.className = 'submit-status hidden';
        }

        function toggleGenerateLoading(isLoading) {
          if (generateLabel) generateLabel.classList.toggle('hidden', isLoading);
          if (generateSpinner) generateSpinner.classList.toggle('hidden', !isLoading);
        }

        function filenameFromDisposition(disposition) {
          if (!disposition) return 'mapping_sheet.xlsx';
          var match = /filename=\"?([^\";]+)\"?/i.exec(disposition);
          return match && match[1] ? match[1] : 'mapping_sheet.xlsx';
        }

        function downloadBlob(blob, filename) {
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        }

        function submitGenerateMapping(evt) {
          evt.preventDefault();
          clearSubmitStatus();
          var validationErr = validateGenerateForm();
          if (validationErr) {
            showSubmitStatus(validationErr, true);
            return;
          }
          toggleGenerateLoading(true);
          var formData = new FormData(mappingForm);

          fetch('/ui/generate-mapping', {
            method: 'POST',
            body: formData,
          })
            .then(function (response) {
              var contentType = response.headers.get('content-type') || '';
              if (!response.ok || contentType.indexOf('application/json') >= 0) {
                return response.json().then(function (err) {
                  throw new Error((err && err.detail) || 'Mapping generation failed.');
                });
              }
              var filename = filenameFromDisposition(response.headers.get('content-disposition'));
              var desktopPath = response.headers.get('x-desktop-path');
              return response.blob().then(function (blob) {
                downloadBlob(blob, filename);
                var msg = 'Data mapping sheet generation completed successfully.';
                if (desktopPath) {
                  msg += ' Saved to Desktop: ' + desktopPath;
                }
                showSubmitStatus(msg, false);
              });
            })
            .catch(function (err) {
              showSubmitStatus(err.message || 'Mapping generation failed.', true);
            })
            .finally(function () {
              toggleGenerateLoading(false);
            });
        }

        function valueOf(id) {
          var el = document.getElementById(id);
          if (!el) return '';
          return (el.value || '').trim();
        }

        function validateGenerateForm() {
          var sourceType = valueOf('source_type');
          var targetType = valueOf('target_type');
          var hasSourceProfile = sourceDatasourceSelect && !!sourceDatasourceSelect.value;
          var hasTargetProfile = targetDatasourceSelect && !!targetDatasourceSelect.value;
          var shouldValidateSource = activeParamTab !== 'target';
          var shouldValidateTarget = activeParamTab !== 'source';

          if (!valueOf('source_object')) return 'Enter source object/table name.';
          if (!valueOf('target_table')) return 'Enter target table name.';

          if (shouldValidateSource && !hasSourceProfile && sourceType === 'salesforce') {
            if (!valueOf('sf_username') || !valueOf('sf_password') || !valueOf('sf_security_token')) {
              return 'For Salesforce source, enter username, password, and security token.';
            }
          }

          if (shouldValidateTarget && !hasTargetProfile && targetType === 'redshift') {
            if (!valueOf('rs_host') || !valueOf('rs_database') || !valueOf('rs_user') || !valueOf('rs_password')) {
              return 'For Redshift target, enter host, database, user, and password.';
            }
          }

          var validateMysql =
            (shouldValidateSource && !hasSourceProfile && sourceType === 'mysql') ||
            (shouldValidateTarget && !hasTargetProfile && targetType === 'mysql');
          if (validateMysql) {
            if (!valueOf('mysql_host') || !valueOf('mysql_database') || !valueOf('mysql_user') || !valueOf('mysql_password')) {
              return 'For MySQL, enter host, database, user, and password.';
            }
          }

          var validateMssql =
            (shouldValidateSource && !hasSourceProfile && sourceType === 'mssql') ||
            (shouldValidateTarget && !hasTargetProfile && targetType === 'mssql');
          if (validateMssql) {
            var authType = valueOf('mssql_auth_type') || 'sql';
            if (!valueOf('mssql_host') || !valueOf('mssql_database')) {
              return 'For MSSQL, enter host and database.';
            }
            if (authType === 'sql' && (!valueOf('mssql_user') || !valueOf('mssql_password'))) {
              return 'For MSSQL SQL authentication, enter user and password.';
            }
          }
          return '';
        }

        var sourceSelect = document.getElementById('source_type');
        var targetSelect = document.getElementById('target_type');
        var sections = document.querySelectorAll('.credential-section');

        function updateVisibility() {
          var source = sourceSelect.value;
          var target = targetSelect.value;

          sections.forEach(function (section) {
            var forRole = section.getAttribute('data-for');
            var type = section.getAttribute('data-type');
            var show = false;
            if (forRole === 'source') {
              show = type === source && activeParamTab !== 'target';
            } else if (forRole === 'target') {
              show = type === target && activeParamTab !== 'source';
            } else if (forRole === 'both') {
              if (activeParamTab === 'source') {
                show = type === source;
              } else if (activeParamTab === 'target') {
                show = type === target;
              } else {
                show = type === source || type === target;
              }
            }
            section.classList.toggle('hidden', !show);

            var inputs = section.querySelectorAll('input, select');
            inputs.forEach(function (input) {
              input.removeAttribute('required');
              var isOptional = input.getAttribute('data-optional') === 'true';
              if (show && !isOptional) input.setAttribute('required', 'required');
            });
          });

          updateMssqlAuth();
        }

        var mssqlAuthSelect = document.getElementById('mssql_auth_type');
        function updateMssqlAuth() {
          if (!mssqlAuthSelect) return;
          var section = document.getElementById('section-mssql');
          var userInput = document.getElementById('mssql_user');
          var pwdInput = document.getElementById('mssql_password');
          if (!section || section.classList.contains('hidden')) {
            if (userInput) userInput.removeAttribute('required');
            if (pwdInput) pwdInput.removeAttribute('required');
            return;
          }
          if (mssqlAuthSelect.value === 'windows') {
            if (userInput) userInput.removeAttribute('required');
            if (pwdInput) pwdInput.removeAttribute('required');
          } else {
            if (userInput) userInput.setAttribute('required', 'required');
            if (pwdInput) pwdInput.setAttribute('required', 'required');
          }
        }

        function getSalesforcePayload() {
          return {
            username: document.getElementById('sf_username').value.trim(),
            password: document.getElementById('sf_password').value,
            security_token: document.getElementById('sf_security_token').value,
            domain: document.getElementById('sf_domain').value || 'login',
          };
        }

        function getRedshiftPayload() {
          return {
            host: document.getElementById('rs_host').value.trim(),
            port: parseInt(document.getElementById('rs_port').value, 10) || 5439,
            database: document.getElementById('rs_database').value.trim(),
            user: document.getElementById('rs_user').value.trim(),
            password: document.getElementById('rs_password').value,
            schema: document.getElementById('rs_schema').value.trim() || 'public',
          };
        }

        function getMssqlPayload() {
          var authType = document.getElementById('mssql_auth_type').value;
          var payload = {
            host: document.getElementById('mssql_host').value.trim(),
            port: parseInt(document.getElementById('mssql_port').value, 10) || 1433,
            database: document.getElementById('mssql_database').value.trim(),
            schema: document.getElementById('mssql_schema').value.trim() || 'dbo',
            auth_type: authType,
          };
          var driver = document.getElementById('mssql_driver').value.trim();
          if (driver) payload.driver = driver;
          if (authType === 'sql') {
            payload.user = document.getElementById('mssql_user').value;
            payload.password = document.getElementById('mssql_password').value;
          } else {
            payload.user = null;
            payload.password = null;
          }
          return payload;
        }

        function getMysqlPayload() {
          return {
            host: document.getElementById('mysql_host').value.trim(),
            port: parseInt(document.getElementById('mysql_port').value, 10) || 3306,
            database: document.getElementById('mysql_database').value.trim(),
            user: document.getElementById('mysql_user').value.trim(),
            password: document.getElementById('mysql_password').value,
            schema: document.getElementById('mysql_schema').value.trim() || null,
          };
        }

        function validatePayload(type, payload) {
          if (type === 'salesforce') {
            if (!payload.username || !payload.password || !payload.security_token) {
              return 'Enter Salesforce username, password, and security token.';
            }
            return null;
          }
          if (type === 'redshift') {
            if (!payload.host || !payload.database || !payload.user || !payload.password) {
              return 'Enter Redshift host, database, user, and password.';
            }
            return null;
          }
          if (type === 'mssql') {
            if (!payload.host || !payload.database) {
              return 'Enter MSSQL host and database first.';
            }
            if (payload.auth_type === 'sql' && (!payload.user || !payload.password)) {
              return 'Enter user and password for SQL auth.';
            }
            return null;
          }
          if (type === 'mysql') {
            if (!payload.host || !payload.database || !payload.user || !payload.password) {
              return 'Enter MySQL host, database, user, and password.';
            }
            return null;
          }
          return 'Invalid connection type.';
        }

        function formatError(data) {
          if (!data) return 'Connection failed.';
          var stage = data.stage ? ('Stage: ' + data.stage + '. ') : '';
          var detail = data.detail || 'Unknown error.';
          var hint = data.hint ? (' Hint: ' + data.hint) : '';
          return stage + detail + hint;
        }

        function testConnection(type, payloadBuilder, btnId, resultId) {
          var btn = document.getElementById(btnId);
          var resultEl = document.getElementById(resultId);
          if (!btn || !resultEl) return;
          var payload = payloadBuilder();
          var validationErr = validatePayload(type, payload);
          if (validationErr) {
            resultEl.textContent = validationErr;
            resultEl.className = 'test-result error';
            return;
          }
          btn.disabled = true;
          resultEl.textContent = 'Testing…';
          resultEl.className = 'test-result';
          fetch('/api/test-connection/' + type, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data.ok) {
                resultEl.textContent = 'Connection successful.';
                resultEl.className = 'test-result success';
              } else {
                resultEl.textContent = formatError(data);
                resultEl.className = 'test-result error';
              }
            })
            .catch(function (err) {
              resultEl.textContent = err.message || 'Request failed.';
              resultEl.className = 'test-result error';
            })
            .finally(function () {
              btn.disabled = false;
            });
        }

        sourceSelect.addEventListener('change', function () {
          updateVisibility();
          refreshDatasourceOptions();
        });
        targetSelect.addEventListener('change', function () {
          updateVisibility();
          refreshDatasourceOptions();
        });
        if (launchWorkspaceBtn) {
          launchWorkspaceBtn.addEventListener('click', launchWorkspace);
        }
        if (launchFromPresentationBtn) {
          launchFromPresentationBtn.addEventListener('click', launchWorkspace);
        }
        if (presentationModeBtn) {
          presentationModeBtn.addEventListener('click', enterPresentationMode);
        }
        if (exitPresentationBtn) {
          exitPresentationBtn.addEventListener('click', exitPresentationMode);
        }
        if (backHomeBtn) {
          backHomeBtn.addEventListener('click', goHome);
        }
        if (sourceLoadBtn) {
          sourceLoadBtn.addEventListener('click', function () { loadObjectsForRole('source'); });
        }
        if (targetLoadBtn) {
          targetLoadBtn.addEventListener('click', function () { loadObjectsForRole('target'); });
        }
        if (sourceDatasourceSelect) {
          sourceDatasourceSelect.addEventListener('change', function () {
            loadSchemasForRole('source');
          });
        }
        if (targetDatasourceSelect) {
          targetDatasourceSelect.addEventListener('change', function () {
            loadSchemasForRole('target');
          });
        }
        if (sourceSchemaSelect) {
          sourceSchemaSelect.addEventListener('change', function () {
            loadObjectsForRole('source');
          });
        }
        if (targetSchemaSelect) {
          targetSchemaSelect.addEventListener('change', function () {
            loadObjectsForRole('target');
          });
        }
        paramTabs.forEach(function (tabBtn) {
          tabBtn.addEventListener('click', function () {
            activeParamTab = tabBtn.getAttribute('data-tab') || 'all';
            paramTabs.forEach(function (btn) {
              btn.classList.toggle('active', btn === tabBtn);
            });
            updateVisibility();
          });
        });
        if (mappingForm) {
          mappingForm.addEventListener('submit', submitGenerateMapping);
        }
        initPasswordToggles();
        loadDatasources();
        if (mssqlAuthSelect) {
          mssqlAuthSelect.addEventListener('change', updateMssqlAuth);
        }
        var mssqlTestBtn = document.getElementById('mssql-test-btn');
        if (mssqlTestBtn) {
          mssqlTestBtn.addEventListener('click', function () {
            testConnection('mssql', getMssqlPayload, 'mssql-test-btn', 'mssql-test-result');
          });
        }
        var sfTestBtn = document.getElementById('sf-test-btn');
        if (sfTestBtn) {
          sfTestBtn.addEventListener('click', function () {
            testConnection('salesforce', getSalesforcePayload, 'sf-test-btn', 'sf-test-result');
          });
        }
        var rsTestBtn = document.getElementById('rs-test-btn');
        if (rsTestBtn) {
          rsTestBtn.addEventListener('click', function () {
            testConnection('redshift', getRedshiftPayload, 'rs-test-btn', 'rs-test-result');
          });
        }
        var mysqlTestBtn = document.getElementById('mysql-test-btn');
        if (mysqlTestBtn) {
          mysqlTestBtn.addEventListener('click', function () {
            testConnection('mysql', getMysqlPayload, 'mysql-test-btn', 'mysql-test-result');
          });
        }
        updateVisibility();
      })();
    </script>
  </body>
</html>
