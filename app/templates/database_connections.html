<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Connections</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #e5e7eb; }
      .top { height: 52px; background: #1e3a8a; display: flex; align-items: center; justify-content: space-between; padding: 0 14px; }
      .shell { display: grid; grid-template-columns: 230px 1fr; min-height: calc(100vh - 52px); }
      .nav { background: #0f172a; border-right: 1px solid #1f2937; padding: 14px 10px; }
      .nav a { display: block; color: #cbd5e1; text-decoration: none; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; }
      .nav a.active, .nav a:hover { background: #1e3a8a; color: #fff; }
      .main { padding: 18px; }
      .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      .btn { background: #2563eb; color: #fff; border: 0; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      .msg { font-size: 0.85rem; color: #93c5fd; margin-bottom: 8px; }
      .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
      .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 10px; padding: 12px; }
      .status { color: #10b981; font-size: 0.85rem; margin-top: 3px; }
      .status.fail { color: #ef4444; }
      .small { color: #94a3b8; font-size: 0.82rem; margin-top: 2px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; }
      .modal.show { display: flex; }
      .modal-card { width: min(720px, 92vw); background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 14px; }
      input, select, textarea { width: 100%; box-sizing: border-box; background: #111827; color: #e5e7eb; border: 1px solid #334155; border-radius: 8px; padding: 8px; }
      textarea { min-height: 110px; font-family: Consolas, monospace; }
    </style>
  </head>
  <body>
    <div class="top">
      <div><strong>Data Mapping Studio</strong></div>
      <div>{{ username }} ({{ user_role }}) | <a href="/logout" style="color:#dbeafe;">Logout</a></div>
    </div>
    <div class="shell">
      <div class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/mapping">Mapping Workspace</a>
        <a href="/mapping-history">Mapping History</a>
        <a href="/datasources" class="active">Database Connections</a>
        <a href="/settings">Settings</a>
        <a href="/audit-logs">Audit Logs</a>
      </div>
      <div class="main">
        <div class="title-row">
          <div>
            <h2 style="margin:0;">Database Connections</h2>
            <div style="color:#94a3b8;">Manage configured data sources</div>
          </div>
          <button class="btn" id="open_create" type="button">+ Add New Connection</button>
        </div>
        <div class="msg" id="msg"></div>
        <div id="cards" class="grid"></div>
      </div>
    </div>

    <div id="create_modal" class="modal">
      <div class="modal-card">
        <h3 style="margin-top:0;">Create Data Source</h3>
        <div class="row">
          <div>
            <label>Name</label>
            <input id="ds_name" placeholder="e.g. prod-mssql-finance" />
          </div>
          <div>
            <label>Type</label>
            <select id="ds_type">
              <option value="mssql">mssql</option>
              <option value="mysql">mysql</option>
              <option value="redshift">redshift</option>
              <option value="salesforce">salesforce</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div>
            <label>Owner Role</label>
            <select id="ds_owner_role">
              <option value="all">all</option>
              <option value="admin">admin</option>
              <option value="user">user</option>
            </select>
          </div>
          <div></div>
        </div>
        <div style="margin-top:8px;">
          <label>Credentials JSON</label>
          <textarea id="ds_credentials" placeholder='{"host":"localhost","database":"mydb","user":"u","password":"p"}'></textarea>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
          <button type="button" id="cancel_modal" class="btn" style="background:#334155;">Cancel</button>
          <button type="button" id="create_ds_btn" class="btn">Create</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        var cardsEl = document.getElementById('cards');
        var msgEl = document.getElementById('msg');
        var modal = document.getElementById('create_modal');
        function show(msg, isErr) { msgEl.textContent = msg || ''; msgEl.style.color = isErr ? '#fca5a5' : '#93c5fd'; }

        function cardHtml(d) {
          return '<div class="card">' +
            '<div style="font-weight:700;">' + d.name + '</div>' +
            '<div class="small">' + d.connection_type + '</div>' +
            '<div class="status">Configured</div>' +
            '<div class="small">Owner role: ' + (d.owner_role || 'all') + '</div>' +
            '<div class="small">Created by: ' + (d.created_by || '') + '</div>' +
            '<div style="margin-top:10px;display:flex;gap:8px;">' +
              '<button class="btn" data-test="' + d.id + '" style="padding:8px 10px;">Test Connection</button>' +
              '<button class="btn" data-del="' + d.id + '" style="padding:8px 10px;background:#b91c1c;">Delete</button>' +
            '</div>' +
          '</div>';
        }

        function load() {
          fetch('/api/datasources')
            .then(function (r) { return r.json(); })
            .then(function (data) {
              var rows = data.datasources || [];
              cardsEl.innerHTML = rows.map(cardHtml).join('');
              cardsEl.querySelectorAll('button[data-del]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                  fetch('/api/datasources/' + btn.getAttribute('data-del'), { method: 'DELETE' })
                    .then(function (r) {
                      if (!r.ok) throw new Error('Delete failed');
                      show('Datasource deleted.');
                      load();
                    })
                    .catch(function (e) { show(e.message || 'Delete failed', true); });
                });
              });
              cardsEl.querySelectorAll('button[data-test]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                  var id = btn.getAttribute('data-test');
                  fetch('/api/datasources/' + id + '/schemas')
                    .then(function (r) { return r.json(); })
                    .then(function () { show('Connection test completed successfully.'); })
                    .catch(function (e) { show(e.message || 'Connection test failed', true); });
                });
              });
            })
            .catch(function (e) { show(e.message || 'Failed to load datasources', true); });
        }

        document.getElementById('open_create').addEventListener('click', function () { modal.classList.add('show'); });
        document.getElementById('cancel_modal').addEventListener('click', function () { modal.classList.remove('show'); });
        modal.addEventListener('click', function (evt) {
          if (evt.target === modal) modal.classList.remove('show');
        });

        document.getElementById('create_ds_btn').addEventListener('click', function () {
          var name = document.getElementById('ds_name').value.trim();
          var connection_type = document.getElementById('ds_type').value;
          var owner_role = document.getElementById('ds_owner_role').value;
          var credentialsText = document.getElementById('ds_credentials').value.trim();
          if (!name || !credentialsText) { show('Enter name and credentials JSON.', true); return; }
          var credentials;
          try { credentials = JSON.parse(credentialsText); } catch (e) { show('Invalid credentials JSON.', true); return; }
          fetch('/api/datasources', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, connection_type: connection_type, owner_role: owner_role, credentials: credentials })
          })
            .then(function (r) {
              if (!r.ok) return r.json().then(function (e) { throw new Error((e && e.detail) || 'Create failed'); });
              return r.json();
            })
            .then(function () {
              show('Data source created successfully.');
              modal.classList.remove('show');
              document.getElementById('ds_name').value = '';
              document.getElementById('ds_credentials').value = '';
              load();
            })
            .catch(function (e) { show(e.message || 'Create failed', true); });
        });

        load();
      })();
    </script>
  </body>
</html>
