<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #0b1220; color: #e5e7eb; }
      .top { height: 52px; background: #1e3a8a; display: flex; align-items: center; justify-content: space-between; padding: 0 14px; }
      .shell { display: grid; grid-template-columns: 230px 1fr; min-height: calc(100vh - 52px); }
      .nav { background: #0f172a; border-right: 1px solid #1f2937; padding: 14px 10px; }
      .nav a { display: block; color: #cbd5e1; text-decoration: none; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; }
      .nav a.active, .nav a:hover { background: #1e3a8a; color: #fff; }
      .main { padding: 18px; }
      .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 10px; padding: 14px; margin-bottom: 12px; max-width: 900px; }
      label { display: block; margin-bottom: 7px; font-size: 0.9rem; }
      input, select, textarea { width: 100%; box-sizing: border-box; background: #111827; color: #e5e7eb; border: 1px solid #334155; border-radius: 8px; padding: 8px; }
      textarea { min-height: 70px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .check { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #1f2937; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 8px; border-bottom: 1px solid #1f2937; font-size: 0.88rem; }
      .btn { background: #2563eb; color: #fff; border: 0; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      .msg { font-size: 0.85rem; margin-top: 8px; }
      .msg.ok { color: #93c5fd; }
      .msg.err { color: #fca5a5; }
      .mini { background: #334155; color: #fff; border: 0; border-radius: 6px; padding: 6px 8px; cursor: pointer; margin-right: 6px; }
      .mini.danger { background: #b91c1c; }
    </style>
  </head>
  <body>
    <div class="top">
      <div><strong>Data Mapping Studio</strong></div>
      <div>{{ username }} ({{ user_role }}) | <a href="/logout" style="color:#dbeafe;">Logout</a></div>
    </div>
    <div class="shell">
      <div class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/mapping">Mapping Workspace</a>
        <a href="/mapping-history">Mapping History</a>
        <a href="/datasources">Database Connections</a>
        <a href="/settings" class="active">Settings</a>
        <a href="/audit-logs">Audit Logs</a>
      </div>
      <div class="main">
        <h2 style="margin:0 0 4px 0;">Settings</h2>
        <div style="color:#94a3b8;margin-bottom:10px;">Configure application preferences</div>

        <div class="card">
          <h4>Default Mapping Settings</h4>
          <div class="row">
            <div>
              <label>Default Fuzzy Threshold</label>
              <input type="range" min="50" max="95" value="80" />
            </div>
            <div>
              <label>Default Matching Mode</label>
              <select><option>Bulk Multi-table Auto Mapping</option><option>One-to-One Table Mapping</option></select>
            </div>
          </div>
          <label style="margin-top:8px;">Allowed Prefix/Suffix Patterns</label>
          <textarea>_id,_cd,tbl_,v_tmp_</textarea>
        </div>

        <div class="card">
          <h4>System Settings</h4>
          <div class="check"><span>Enable Audit Logging</span><input type="checkbox" checked /></div>
          <div class="check"><span>Auto-save Results</span><input type="checkbox" checked /></div>
          <div class="check"><span>Email Notifications</span><input type="checkbox" /></div>
          <label style="margin-top:10px;">Max Concurrent Mappings</label>
          <input type="number" value="5" min="1" max="20" style="max-width:220px;" />
        </div>

        <div class="card">
          <h4>Role Permissions</h4>
          <table>
            <thead><tr><th>Feature</th><th>Admin</th><th>Analyst</th><th>Viewer</th></tr></thead>
            <tbody>
              <tr><td>Create Mappings</td><td>Yes</td><td>Yes</td><td>No</td></tr>
              <tr><td>View History</td><td>Yes</td><td>Yes</td><td>Yes</td></tr>
              <tr><td>Export Results</td><td>Yes</td><td>Yes</td><td>No</td></tr>
              <tr><td>Manage Connections</td><td>Yes</td><td>No</td><td>No</td></tr>
              <tr><td>Modify Settings</td><td>Yes</td><td>No</td><td>No</td></tr>
            </tbody>
          </table>
          <div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn" type="button">Save Settings</button></div>
        </div>

        {% if can_manage_users %}
        <div class="card">
          <h4>User Management (Admin)</h4>
          <div class="row">
            <div>
              <label>Username</label>
              <input id="new_username" placeholder="e.g. data_analyst" />
            </div>
            <div>
              <label>Role</label>
              <select id="new_role">
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
            </div>
          </div>
          <label style="margin-top:8px;">Temporary Password</label>
          <input id="new_password" type="password" placeholder="Min 10 chars with upper/lower/number/special" />
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button class="btn" id="create_user_btn" type="button">Create User</button>
          </div>
          <div id="users_msg" class="msg ok"></div>

          <table style="margin-top:10px;">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Active</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users_tbody"></tbody>
          </table>
        </div>
        {% endif %}
      </div>
    </div>
    {% if can_manage_users %}
    <script>
      (function () {
        var msgEl = document.getElementById('users_msg');
        var tbody = document.getElementById('users_tbody');
        var currentUsername = "{{ username }}";

        function show(msg, isErr) {
          msgEl.textContent = msg || '';
          msgEl.className = 'msg ' + (isErr ? 'err' : 'ok');
        }

        function requestJson(url, options) {
          return fetch(url, options).then(function (response) {
            return response.text().then(function (text) {
              var payload = {};
              try { payload = text ? JSON.parse(text) : {}; } catch (e) { payload = {}; }
              if (!response.ok) {
                throw new Error((payload && payload.detail) || text || (response.status + ' ' + response.statusText));
              }
              return payload;
            });
          });
        }

        function fmt(ts) {
          if (!ts) return '-';
          var d = new Date(ts);
          if (Number.isNaN(d.getTime())) return '-';
          return d.toISOString().replace('T', ' ').slice(0, 16);
        }

        function rowHtml(u) {
          var username = u.username || '';
          var role = u.role || 'user';
          var active = !!u.active;
          return '<tr data-user="' + username + '">' +
            '<td>' + username + (username === currentUsername ? ' (you)' : '') + '</td>' +
            '<td><select data-role="' + username + '">' +
              '<option value="user"' + (role === 'user' ? ' selected' : '') + '>user</option>' +
              '<option value="admin"' + (role === 'admin' ? ' selected' : '') + '>admin</option>' +
            '</select></td>' +
            '<td><select data-active="' + username + '">' +
              '<option value="true"' + (active ? ' selected' : '') + '>true</option>' +
              '<option value="false"' + (!active ? ' selected' : '') + '>false</option>' +
            '</select></td>' +
            '<td>' + fmt(u.last_login_at) + '</td>' +
            '<td>' +
              '<button class="mini" data-save="' + username + '">Save</button>' +
              '<button class="mini" data-reset="' + username + '">Reset Password</button>' +
              '<button class="mini danger" data-delete="' + username + '">Delete</button>' +
            '</td>' +
          '</tr>';
        }

        function bindRowActions() {
          tbody.querySelectorAll('button[data-save]').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var user = btn.getAttribute('data-save');
              var roleEl = tbody.querySelector('select[data-role="' + user + '"]');
              var activeEl = tbody.querySelector('select[data-active="' + user + '"]');
              requestJson('/api/admin/users/' + encodeURIComponent(user), {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  role: roleEl ? roleEl.value : 'user',
                  active: activeEl ? activeEl.value === 'true' : true
                })
              })
                .then(function () { show('Updated user: ' + user); loadUsers(); })
                .catch(function (e) { show(e.message || 'Update failed', true); });
            });
          });

          tbody.querySelectorAll('button[data-reset]').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var user = btn.getAttribute('data-reset');
              var pwd = window.prompt('Enter new password for ' + user + ':');
              if (!pwd) return;
              requestJson('/api/admin/users/' + encodeURIComponent(user) + '/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_password: pwd })
              })
                .then(function () { show('Password reset for: ' + user); })
                .catch(function (e) { show(e.message || 'Password reset failed', true); });
            });
          });

          tbody.querySelectorAll('button[data-delete]').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var user = btn.getAttribute('data-delete');
              if (!window.confirm('Delete user ' + user + '?')) return;
              requestJson('/api/admin/users/' + encodeURIComponent(user), { method: 'DELETE' })
                .then(function () { show('Deleted user: ' + user); loadUsers(); })
                .catch(function (e) { show(e.message || 'Delete failed', true); });
            });
          });
        }

        function loadUsers() {
          requestJson('/api/admin/users')
            .then(function (data) {
              var users = (data && data.users) || [];
              tbody.innerHTML = users.map(rowHtml).join('');
              bindRowActions();
            })
            .catch(function (e) { show(e.message || 'Failed to load users', true); });
        }

        document.getElementById('create_user_btn').addEventListener('click', function () {
          var username = (document.getElementById('new_username').value || '').trim();
          var role = document.getElementById('new_role').value || 'user';
          var password = document.getElementById('new_password').value || '';
          if (!username || !password) {
            show('Username and temporary password are required.', true);
            return;
          }
          requestJson('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username, password: password, role: role })
          })
            .then(function () {
              document.getElementById('new_username').value = '';
              document.getElementById('new_password').value = '';
              show('User created successfully.');
              loadUsers();
            })
            .catch(function (e) { show(e.message || 'Create user failed', true); });
        });

        loadUsers();
      })();
    </script>
    {% endif %}
  </body>
</html>
